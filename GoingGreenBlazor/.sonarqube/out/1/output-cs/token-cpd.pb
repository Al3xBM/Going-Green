ÞS
CD:\Git Repos\Going-Green\UserService\Controllers\UsersController.cs
	namespace 	
UserService
 
. 
Controllers !
{ 
[ 
	Authorize 
] 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
UsersController  
:! "
ControllerBase# 1
{ 
private 
readonly 
IUserService %
_userService& 2
;2 3
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
AppSettings $
_appSettings% 1
;1 2
public 
UsersController 
( 
IUserService 
userService $
,$ %
IMapper 
mapper 
, 
IOptions   
<   
AppSettings    
>    !
appSettings  " -
)  - .
{!! 	
_userService"" 
="" 
userService"" &
;""& '
_mapper## 
=## 
mapper## 
;## 
_appSettings$$ 
=$$ 
appSettings$$ &
.$$& '
Value$$' ,
;$$, -
}%% 	
['' 	
AllowAnonymous''	 
]'' 
[(( 	
HttpPost((	 
((( 
$str(( 
)(( 
](( 
public)) 
IActionResult)) 
Register)) %
())% &
[))& '
FromBody))' /
]))/ 0
RegisterModel))1 >
model))? D
)))D E
{** 	
var,, 
user,, 
=,, 
_mapper,, 
.,, 
Map,, "
<,," #
User,,# '
>,,' (
(,,( )
model,,) .
),,. /
;,,/ 0
try.. 
{// 
_userService11 
.11 
Create11 #
(11# $
user11$ (
,11( )
model11* /
.11/ 0
Password110 8
)118 9
;119 :
return22 
Ok22 
(22 
user22 
)22 
;22  
}33 
catch44 
(44 
UserException44  
ex44! #
)44# $
{55 
return77 

BadRequest77 !
(77! "
new77" %
{77& '
message77( /
=770 1
ex772 4
.774 5
Message775 <
}77= >
)77> ?
;77? @
}88 
}99 	
[;; 	
AllowAnonymous;;	 
];; 
[<< 	
HttpPost<<	 
(<< 
$str<<  
)<<  !
]<<! "
public== 
IActionResult== 
Authenticate== )
(==) *
[==* +
FromBody==+ 3
]==3 4
AuthenticateModel==5 F
model==G L
)==L M
{>> 	
var?? 
user?? 
=?? 
_userService?? #
.??# $
Authenticate??$ 0
(??0 1
model??1 6
.??6 7
Email??7 <
,??< =
model??> C
.??C D
Password??D L
)??L M
;??M N
ifAA 
(AA 
userAA 
==AA 
nullAA 
)AA 
returnBB 
UnauthorizedBB #
(BB# $
newBB$ '
{BB( )
messageBB* 1
=BB2 3
$strBB4 T
}BBU V
)BBV W
;BBW X
varDD 
tokenHandlerDD 
=DD 
newDD "#
JwtSecurityTokenHandlerDD# :
(DD: ;
)DD; <
;DD< =
varEE 
keyEE 
=EE 
EncodingEE 
.EE 
UTF8EE #
.EE# $
GetBytesEE$ ,
(EE, -
_appSettingsEE- 9
.EE9 :
SecretEE: @
)EE@ A
;EEA B
varFF 
tokenDescriptorFF 
=FF  !
newFF" %#
SecurityTokenDescriptorFF& =
{GG 
SubjectHH 
=HH 
newHH 
ClaimsIdentityHH ,
(HH, -
newHH- 0
ClaimHH1 6
[HH6 7
]HH7 8
{II 
newJJ 
ClaimJJ 
(JJ 

ClaimTypesJJ (
.JJ( )
NameJJ) -
,JJ- .
userJJ/ 3
.JJ3 4
IdJJ4 6
.JJ6 7
ToStringJJ7 ?
(JJ? @
)JJ@ A
)JJA B
}KK 
)KK 
,KK 
ExpiresLL 
=LL 
DateTimeLL "
.LL" #
UtcNowLL# )
.LL) *
AddDaysLL* 1
(LL1 2
$numLL2 3
)LL3 4
,LL4 5
SigningCredentialsMM "
=MM# $
newMM% (
SigningCredentialsMM) ;
(MM; <
newMM< ? 
SymmetricSecurityKeyMM@ T
(MMT U
keyMMU X
)MMX Y
,MMY Z
SecurityAlgorithmsMM[ m
.MMm n 
HmacSha256Signature	MMn 
)
MM ‚
}NN 
;NN 
varOO 
tokenOO 
=OO 
tokenHandlerOO $
.OO$ %
CreateTokenOO% 0
(OO0 1
tokenDescriptorOO1 @
)OO@ A
;OOA B
varPP 
tokenStringPP 
=PP 
tokenHandlerPP *
.PP* +

WriteTokenPP+ 5
(PP5 6
tokenPP6 ;
)PP; <
;PP< =
HttpContextRR 
.RR 
ResponseRR  
.RR  !
CookiesRR! (
.RR( )
AppendRR) /
(RR/ 0
$strRR0 5
,RR5 6
tokenStringRR7 B
)RRB C
;RRC D
returnUU 
OkUU 
(UU 
newUU 
{VV 
IdWW 
=WW 
userWW 
.WW 
IdWW 
,WW 
EmailXX 
=XX 
userXX 
.XX 
EmailXX "
,XX" #
	FirstNameYY 
=YY 
userYY  
.YY  !
	FirstNameYY! *
,YY* +
LastNameZZ 
=ZZ 
userZZ 
.ZZ  
LastNameZZ  (
,ZZ( )
Token[[ 
=[[ 
tokenString[[ #
}\\ 
)\\ 
;\\ 
}]] 	
[__ 	
HttpGet__	 
]__ 
[`` 	
	Authorize``	 
(`` !
AuthenticationSchemes`` (
=``) *
JwtBearerDefaults``+ <
.``< = 
AuthenticationScheme``= Q
)``Q R
]``R S
publicaa 
IActionResultaa 
GetAllaa #
(aa# $
)aa$ %
{bb 	
varcc 
userscc 
=cc 
_userServicecc $
.cc$ %
GetAllcc% +
(cc+ ,
)cc, -
;cc- .
vardd 
modeldd 
=dd 
_mapperdd 
.dd  
Mapdd  #
<dd# $
IListdd$ )
<dd) *
	UserModeldd* 3
>dd3 4
>dd4 5
(dd5 6
usersdd6 ;
)dd; <
;dd< =
returnee 
Okee 
(ee 
modelee 
)ee 
;ee 
}ff 	
[hh 	
HttpGethh	 
(hh 
$strhh 
)hh 
]hh 
[ii 	
	Authorizeii	 
(ii !
AuthenticationSchemesii (
=ii) *
JwtBearerDefaultsii+ <
.ii< = 
AuthenticationSchemeii= Q
)iiQ R
]iiR S
publicjj 
IActionResultjj 
GetByIdjj $
(jj$ %
intjj% (
idjj) +
)jj+ ,
{kk 	
varll 
userll 
=ll 
_userServicell #
.ll# $
GetByIdll$ +
(ll+ ,
idll, .
)ll. /
;ll/ 0
varmm 
modelmm 
=mm 
_mappermm 
.mm  
Mapmm  #
<mm# $
	UserModelmm$ -
>mm- .
(mm. /
usermm/ 3
)mm3 4
;mm4 5
returnnn 
Oknn 
(nn 
modelnn 
)nn 
;nn 
}oo 	
[qq 	
HttpPutqq	 
(qq 
$strqq 
)qq 
]qq 
[rr 	
	Authorizerr	 
(rr !
AuthenticationSchemesrr (
=rr) *
JwtBearerDefaultsrr+ <
.rr< = 
AuthenticationSchemerr= Q
)rrQ R
]rrR S
publicss 
IActionResultss 
Updatess #
(ss# $
intss$ '
idss( *
,ss* +
[ss, -
FromBodyss- 5
]ss5 6
UpdateModelss7 B
modelssC H
)ssH I
{tt 	
varvv 
uservv 
=vv 
_mappervv 
.vv 
Mapvv "
<vv" #
Uservv# '
>vv' (
(vv( )
modelvv) .
)vv. /
;vv/ 0
userww 
.ww 
Idww 
=ww 
idww 
;ww 
tryyy 
{zz 
_userService|| 
.|| 
Update|| #
(||# $
user||$ (
,||( )
model||* /
.||/ 0
Password||0 8
)||8 9
;||9 :
return}} 
	NoContent}}  
(}}  !
)}}! "
;}}" #
}~~ 
catch 
( 
UserException  
ex! #
)# $
{
€€ 
return
‚‚ 

BadRequest
‚‚ !
(
‚‚! "
new
‚‚" %
{
‚‚& '
message
‚‚( /
=
‚‚0 1
ex
‚‚2 4
.
‚‚4 5
Message
‚‚5 <
}
‚‚= >
)
‚‚> ?
;
‚‚? @
}
ƒƒ 
}
„„ 	
[
†† 	

HttpDelete
††	 
(
†† 
$str
†† 
)
†† 
]
†† 
[
‡‡ 	
	Authorize
‡‡	 
(
‡‡ #
AuthenticationSchemes
‡‡ (
=
‡‡) *
JwtBearerDefaults
‡‡+ <
.
‡‡< ="
AuthenticationScheme
‡‡= Q
)
‡‡Q R
]
‡‡R S
public
ˆˆ 
IActionResult
ˆˆ 
Delete
ˆˆ #
(
ˆˆ# $
int
ˆˆ$ '
id
ˆˆ( *
)
ˆˆ* +
{
‰‰ 	
_userService
ŠŠ 
.
ŠŠ 
Delete
ŠŠ 
(
ŠŠ  
id
ŠŠ  "
)
ŠŠ" #
;
ŠŠ# $
return
‹‹ 
	NoContent
‹‹ 
(
‹‹ 
)
‹‹ 
;
‹‹ 
}
ŒŒ 	
}
 
}ŽŽ þ
TD:\Git Repos\Going-Green\UserService\Data\Migrations\20210328175331_InitialCreate.cs
	namespace 	
UserService
 
. 
Data 
. 

Migrations %
{ 
public 

partial 
class 
InitialCreate &
:' (
	Migration) 2
{ 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder		 
.		 
CreateTable		 (
(		( )
name

 
:

 
$str

 
,

 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ :
,: ;
true< @
)@ A
,A B
	FirstName 
= 
table  %
.% &
Column& ,
<, -
string- 3
>3 4
(4 5
type5 9
:9 :
$str; A
,A B
nullableC K
:K L
trueM Q
)Q R
,R S
LastName 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Email 
= 
table !
.! "
Column" (
<( )
string) /
>/ 0
(0 1
type1 5
:5 6
$str7 =
,= >
nullable? G
:G H
trueI M
)M N
,N O
PasswordHash  
=! "
table# (
.( )
Column) /
</ 0
byte0 4
[4 5
]5 6
>6 7
(7 8
type8 <
:< =
$str> D
,D E
nullableF N
:N O
trueP T
)T U
,U V
PasswordSalt  
=! "
table# (
.( )
Column) /
</ 0
byte0 4
[4 5
]5 6
>6 7
(7 8
type8 <
:< =
$str> D
,D E
nullableF N
:N O
trueP T
)T U
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% .
,. /
x0 1
=>2 4
x5 6
.6 7
Id7 9
)9 :
;: ;
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropTable &
(& '
name 
: 
$str 
) 
; 
} 	
}   
}!! Ø	
5D:\Git Repos\Going-Green\UserService\Entities\User.cs
	namespace 	
UserService
 
. 
Entities 
{ 
public 

class 
User 
{ 
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
public 
string 
	FirstName 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
LastName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public		 
byte		 
[		 
]		 
PasswordHash		 "
{		# $
get		% (
;		( )
set		* -
;		- .
}		/ 0
public

 
byte

 
[

 
]

 
PasswordSalt

 "
{

# $
get

% (
;

( )
set

* -
;

- .
}

/ 0
} 
} ¡
;D:\Git Repos\Going-Green\UserService\Helpers\AppSettings.cs
	namespace 	
UserService
 
. 
Helpers 
{ 
public 

class 
AppSettings 
{ 
public 
string 
Secret 
{ 
get "
;" #
set$ '
;' (
}) *
} 
} ú
AD:\Git Repos\Going-Green\UserService\Helpers\AutoMapperProfile.cs
	namespace 	
UserService
 
. 
Helpers 
{ 
public 

class 
AutoMapperProfile "
:# $
Profile% ,
{ 
public		 
AutoMapperProfile		  
(		  !
)		! "
{

 	
	CreateMap 
< 
User 
, 
	UserModel %
>% &
(& '
)' (
;( )
	CreateMap 
< 
RegisterModel #
,# $
User% )
>) *
(* +
)+ ,
;, -
	CreateMap 
< 
UpdateModel !
,! "
User# '
>' (
(( )
)) *
;* +
} 	
} 
} ¿

;D:\Git Repos\Going-Green\UserService\Helpers\DataContext.cs
	namespace 	
UserService
 
. 
Helpers 
{ 
public 

class 
DataContext 
: 
	DbContext (
{ 
public 
DataContext 
( 
) 
{		 	
}

 	
public 
DataContext 
( 
DbContextOptions +
<+ ,
DataContext, 7
>7 8
options9 @
)@ A
:B C
baseD H
(H I
optionsI P
)P Q
{ 	
} 	
public 
DbSet 
< 
User 
> 
Users  
{! "
get# &
;& '
set( +
;+ ,
}- .
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
modelBuilder 
. 
Entity 
<  
User  $
>$ %
(% &
)& '
. 
ToTable 
( 
$str 
)  
;  !
} 	
} 
} ¸
=D:\Git Repos\Going-Green\UserService\Helpers\UserException.cs
	namespace 	
UserService
 
. 
Helpers 
{ 
[

 
System

 
.

 !
SerializableAttribute

 !
(

! "
)

" #
]

# $
public 

class 
UserException 
:  
	Exception! *
{ 
public 
UserException 
( 
) 
:  
base! %
(% &
)& '
{ 	
} 	
public 
UserException 
( 
string #
message$ +
)+ ,
:- .
base/ 3
(3 4
message4 ;
); <
{ 	
} 	
public 
UserException 
( 
string #
message$ +
,+ ,
params- 3
object4 :
[: ;
]; <
args= A
)A B
:C D
baseE I
(I J
StringJ P
.P Q
FormatQ W
(W X
CultureInfoX c
.c d
CurrentCultured r
,r s
messaget {
,{ |
args	} 
)
 ‚
)
‚ ƒ
{ 	
} 	
	protected 
UserException 
(  
SerializationInfo  1
info2 6
,6 7
StreamingContext8 H
contextI P
)P Q
:R S
baseT X
(X Y
infoY ]
,] ^
context_ f
)f g
{ 	
} 	
} 
} Ö
FD:\Git Repos\Going-Green\UserService\Models\Users\AuthenticateModel.cs
	namespace 	
UserService
 
. 
Models 
. 
Users "
{ 
public 

class 
AuthenticateModel "
{ 
[ 	
Required	 
] 
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
[

 	
Required

	 
]

 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} ï
BD:\Git Repos\Going-Green\UserService\Models\Users\RegisterModel.cs
	namespace 	
UserService
 
. 
Models 
. 
Users "
{ 
public 

class 
RegisterModel 
{ 
[ 	
Required	 
] 
public 
string 
	FirstName 
{  !
get" %
;% &
set' *
;* +
}, -
[

 	
Required

	 
]

 
public 
string 
LastName 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
Required	 
] 
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
[ 	
Required	 
] 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} ›
@D:\Git Repos\Going-Green\UserService\Models\Users\UpdateModel.cs
	namespace 	
UserService
 
. 
Models 
. 
Users "
{ 
public 
class	 
UpdateModel 
{ 
public 
string 
	FirstName 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
LastName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
}		 
}

 Ž
>D:\Git Repos\Going-Green\UserService\Models\Users\UserModel.cs
	namespace 	
UserService
 
. 
Models 
. 
Users "
{ 
public 
class	 
	UserModel 
{ 
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
public 
string 
	FirstName 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
LastName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
}		 
}

 á	
/D:\Git Repos\Going-Green\UserService\Program.cs
	namespace 	
UserService
 
{ 
public 

static 
class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
=>		 
CreateHostBuilder		  
(		  !
args		! %
)		% &
.		& '
Build		' ,
(		, -
)		- .
.		. /
Run		/ 2
(		2 3
)		3 4
;		4 5
public 
static 
IHostBuilder "
CreateHostBuilder# 4
(4 5
string5 ;
[; <
]< =
args> B
)B C
=> 
Host 
.  
CreateDefaultBuilder (
(( )
args) -
)- .
. $
ConfigureWebHostDefaults )
() *

webBuilder 
=> !

webBuilder" ,
., -

UseStartup- 7
<7 8
Startup8 ?
>? @
(@ A
)A B
)B C
;C D
} 
} ¼	
=D:\Git Repos\Going-Green\UserService\Services\IUserService.cs
	namespace 	
UserService
 
. 
Services 
{ 
public 

	interface 
IUserService !
{ 
User 
Authenticate 
( 
string  
email! &
,& '
string( .
password/ 7
)7 8
;8 9
IEnumerable		 
<		 
User		 
>		 
GetAll		  
(		  !
)		! "
;		" #
User

 
GetById

 
(

 
int

 
id

 
)

 
;

 
User 
Create 
( 
User 
user 
, 
string %
password& .
). /
;/ 0
void 
Update 
( 
User 
user 
, 
string %
password& .
=/ 0
null1 5
)5 6
;6 7
void 
Delete 
( 
int 
id 
) 
; 
} 
} Úk
<D:\Git Repos\Going-Green\UserService\Services\UserService.cs
	namespace 	
UserService
 
. 
Services 
{ 
public		 

class		 
UserService		 
:		 
IUserService		 +
{

 
private 
readonly 
DataContext $
_context% -
;- .
public 
UserService 
( 
DataContext &
context' .
). /
{ 	
_context 
= 
context 
; 
} 	
public 
User 
Authenticate  
(  !
string! '
email( -
,- .
string/ 5
password6 >
)> ?
{ 	
if 
( 
string 
. 
IsNullOrEmpty $
($ %
email% *
)* +
||, .
string/ 5
.5 6
IsNullOrEmpty6 C
(C D
passwordD L
)L M
)M N
return 
null 
; 
var 
user 
= 
_context 
.  
Users  %
.% &
SingleOrDefault& 5
(5 6
x6 7
=>8 :
x; <
.< =
Email= B
==C E
emailF K
)K L
;L M
if 
( 
user 
== 
null 
) 
return 
null 
; 
if 
( 
! 
VerifyPasswordHash #
(# $
password$ ,
,, -
user. 2
.2 3
PasswordHash3 ?
,? @
userA E
.E F
PasswordSaltF R
)R S
)S T
return 
null 
; 
return"" 
user"" 
;"" 
}## 	
public%% 
IEnumerable%% 
<%% 
User%% 
>%%  
GetAll%%! '
(%%' (
)%%( )
{&& 	
return'' 
_context'' 
.'' 
Users'' !
;''! "
}(( 	
public** 
User** 
GetById** 
(** 
int** 
id**  "
)**" #
{++ 	
return,, 
_context,, 
.,, 
Users,, !
.,,! "
Find,," &
(,,& '
id,,' )
),,) *
;,,* +
}-- 	
public// 
User// 
Create// 
(// 
User// 
user//  $
,//$ %
string//& ,
password//- 5
)//5 6
{00 	
if22 
(22 
string22 
.22 
IsNullOrWhiteSpace22 )
(22) *
password22* 2
)222 3
)223 4
throw33 
new33 
UserException33 '
(33' (
$str33( >
)33> ?
;33? @
if55 
(55 
_context55 
.55 
Users55 
.55 
Any55 "
(55" #
x55# $
=>55% '
x55( )
.55) *
Email55* /
==550 2
user553 7
.557 8
Email558 =
)55= >
)55> ?
throw66 
new66 
UserException66 '
(66' (
$str66( 2
+663 4
user665 9
.669 :
Email66: ?
+66@ A
$str66B W
)66W X
;66X Y
byte88 
[88 
]88 
passwordHash88 
,88  
passwordSalt88! -
;88- .
CreatePasswordHash99 
(99 
password99 '
,99' (
out99) ,
passwordHash99- 9
,999 :
out99; >
passwordSalt99? K
)99K L
;99L M
user;; 
.;; 
PasswordHash;; 
=;; 
passwordHash;;  ,
;;;, -
user<< 
.<< 
PasswordSalt<< 
=<< 
passwordSalt<<  ,
;<<, -
_context>> 
.>> 
Users>> 
.>> 
Add>> 
(>> 
user>> #
)>># $
;>>$ %
_context?? 
.?? 
SaveChanges??  
(??  !
)??! "
;??" #
returnAA 
userAA 
;AA 
}BB 	
publicDD 
voidDD 
UpdateDD 
(DD 
UserDD 
userDD  $
,DD$ %
stringDD& ,
passwordDD- 5
=DD6 7
nullDD8 <
)DD< =
{EE 	
varFF 
userParFF 
=FF 
_contextFF "
.FF" #
UsersFF# (
.FF( )
FindFF) -
(FF- .
userFF. 2
.FF2 3
IdFF3 5
)FF5 6
;FF6 7
ifHH 
(HH 
userParHH 
==HH 
nullHH 
)HH  
throwII 
newII 
UserExceptionII '
(II' (
$strII( 8
)II8 9
;II9 :
ifLL 
(LL 
!LL 
stringLL 
.LL 
IsNullOrWhiteSpaceLL *
(LL* +
userLL+ /
.LL/ 0
EmailLL0 5
)LL5 6
&&LL7 9
userLL: >
.LL> ?
EmailLL? D
!=LLE G
userParLLH O
.LLO P
EmailLLP U
)LLU V
{MM 
ifOO 
(OO 
_contextOO 
.OO 
UsersOO "
.OO" #
AnyOO# &
(OO& '
xOO' (
=>OO) +
xOO, -
.OO- .
EmailOO. 3
==OO4 6
userOO7 ;
.OO; <
EmailOO< A
)OOA B
)OOB C
throwPP 
newPP 
UserExceptionPP +
(PP+ ,
$strPP, 4
+PP5 6
userPP7 ;
.PP; <
EmailPP< A
+PPB C
$strPPD W
)PPW X
;PPX Y
userParRR 
.RR 
EmailRR 
=RR 
userRR  $
.RR$ %
EmailRR% *
;RR* +
}SS 
ifVV 
(VV 
!VV 
stringVV 
.VV 
IsNullOrWhiteSpaceVV *
(VV* +
userVV+ /
.VV/ 0
	FirstNameVV0 9
)VV9 :
)VV: ;
userParWW 
.WW 
	FirstNameWW !
=WW" #
userWW$ (
.WW( )
	FirstNameWW) 2
;WW2 3
ifYY 
(YY 
!YY 
stringYY 
.YY 
IsNullOrWhiteSpaceYY *
(YY* +
userYY+ /
.YY/ 0
LastNameYY0 8
)YY8 9
)YY9 :
userParZZ 
.ZZ 
LastNameZZ  
=ZZ! "
userZZ# '
.ZZ' (
LastNameZZ( 0
;ZZ0 1
if]] 
(]] 
!]] 
string]] 
.]] 
IsNullOrWhiteSpace]] *
(]]* +
password]]+ 3
)]]3 4
)]]4 5
{^^ 
byte__ 
[__ 
]__ 
passwordHash__ #
,__# $
passwordSalt__% 1
;__1 2
CreatePasswordHash`` "
(``" #
password``# +
,``+ ,
out``- 0
passwordHash``1 =
,``= >
out``? B
passwordSalt``C O
)``O P
;``P Q
userParbb 
.bb 
PasswordHashbb $
=bb% &
passwordHashbb' 3
;bb3 4
userParcc 
.cc 
PasswordSaltcc $
=cc% &
passwordSaltcc' 3
;cc3 4
}dd 
_contextff 
.ff 
Usersff 
.ff 
Updateff !
(ff! "
userParff" )
)ff) *
;ff* +
_contextgg 
.gg 
SaveChangesgg  
(gg  !
)gg! "
;gg" #
}hh 	
publicjj 
voidjj 
Deletejj 
(jj 
intjj 
idjj !
)jj! "
{kk 	
varll 
userll 
=ll 
_contextll 
.ll  
Usersll  %
.ll% &
Findll& *
(ll* +
idll+ -
)ll- .
;ll. /
ifmm 
(mm 
usermm 
!=mm 
nullmm 
)mm 
{nn 
_contextoo 
.oo 
Usersoo 
.oo 
Removeoo %
(oo% &
useroo& *
)oo* +
;oo+ ,
_contextpp 
.pp 
SaveChangespp $
(pp$ %
)pp% &
;pp& '
}qq 
}rr 	
privatevv 
staticvv 
voidvv 
CreatePasswordHashvv .
(vv. /
stringvv/ 5
passwordvv6 >
,vv> ?
outvv@ C
bytevvD H
[vvH I
]vvI J
passwordHashvvK W
,vvW X
outvvY \
bytevv] a
[vva b
]vvb c
passwordSaltvvd p
)vvp q
{ww 	
ifxx 
(xx 
passwordxx 
==xx 
nullxx  
)xx  !
throwxx" '
newxx( +!
ArgumentNullExceptionxx, A
(xxA B
$strxxB L
)xxL M
;xxM N
ifyy 
(yy 
stringyy 
.yy 
IsNullOrWhiteSpaceyy )
(yy) *
passwordyy* 2
)yy2 3
)yy3 4
throwyy5 :
newyy; >
ArgumentExceptionyy? P
(yyP Q
$str	yyQ ƒ
,
yyƒ „
$str
yy… 
)
yy 
;
yy ‘
using{{ 
({{ 
var{{ 
hmac{{ 
={{ 
new{{ !
System{{" (
.{{( )
Security{{) 1
.{{1 2
Cryptography{{2 >
.{{> ?

HMACSHA512{{? I
({{I J
){{J K
){{K L
{|| 
passwordSalt}} 
=}} 
hmac}} #
.}}# $
Key}}$ '
;}}' (
passwordHash~~ 
=~~ 
hmac~~ #
.~~# $
ComputeHash~~$ /
(~~/ 0
System~~0 6
.~~6 7
Text~~7 ;
.~~; <
Encoding~~< D
.~~D E
UTF8~~E I
.~~I J
GetBytes~~J R
(~~R S
password~~S [
)~~[ \
)~~\ ]
;~~] ^
} 
}
€€ 	
private
‚‚ 
static
‚‚ 
bool
‚‚  
VerifyPasswordHash
‚‚ .
(
‚‚. /
string
‚‚/ 5
password
‚‚6 >
,
‚‚> ?
byte
‚‚@ D
[
‚‚D E
]
‚‚E F

storedHash
‚‚G Q
,
‚‚Q R
byte
‚‚S W
[
‚‚W X
]
‚‚X Y

storedSalt
‚‚Z d
)
‚‚d e
{
ƒƒ 	
if
„„ 
(
„„ 
password
„„ 
==
„„ 
null
„„  
)
„„  !
throw
„„" '
new
„„( +#
ArgumentNullException
„„, A
(
„„A B
$str
„„B L
)
„„L M
;
„„M N
if
…… 
(
…… 
string
…… 
.
……  
IsNullOrWhiteSpace
…… )
(
……) *
password
……* 2
)
……2 3
)
……3 4
throw
……5 :
new
……; >
ArgumentException
……? P
(
……P Q
$str……Q ƒ
,……ƒ „
$str……… 
)…… 
;…… ‘
if
†† 
(
†† 

storedHash
†† 
.
†† 
Length
†† !
!=
††" $
$num
††% '
)
††' (
throw
††) .
new
††/ 2
ArgumentException
††3 D
(
††D E
$str
††E {
,
††{ |
$str††} ‹
)††‹ Œ
;††Œ 
if
‡‡ 
(
‡‡ 

storedSalt
‡‡ 
.
‡‡ 
Length
‡‡ !
!=
‡‡" $
$num
‡‡% (
)
‡‡( )
throw
‡‡* /
new
‡‡0 3
ArgumentException
‡‡4 E
(
‡‡E F
$str
‡‡F }
,
‡‡} ~
$str‡‡ 
)‡‡ Ž
;‡‡Ž 
using
‰‰ 
(
‰‰ 
var
‰‰ 
hmac
‰‰ 
=
‰‰ 
new
‰‰ !
System
‰‰" (
.
‰‰( )
Security
‰‰) 1
.
‰‰1 2
Cryptography
‰‰2 >
.
‰‰> ?

HMACSHA512
‰‰? I
(
‰‰I J

storedSalt
‰‰J T
)
‰‰T U
)
‰‰U V
{
ŠŠ 
var
‹‹ 
computedHash
‹‹  
=
‹‹! "
hmac
‹‹# '
.
‹‹' (
ComputeHash
‹‹( 3
(
‹‹3 4
System
‹‹4 :
.
‹‹: ;
Text
‹‹; ?
.
‹‹? @
Encoding
‹‹@ H
.
‹‹H I
UTF8
‹‹I M
.
‹‹M N
GetBytes
‹‹N V
(
‹‹V W
password
‹‹W _
)
‹‹_ `
)
‹‹` a
;
‹‹a b
for
ŒŒ 
(
ŒŒ 
int
ŒŒ 
i
ŒŒ 
=
ŒŒ 
$num
ŒŒ 
;
ŒŒ 
i
ŒŒ  !
<
ŒŒ" #
computedHash
ŒŒ$ 0
.
ŒŒ0 1
Length
ŒŒ1 7
;
ŒŒ7 8
i
ŒŒ9 :
++
ŒŒ: <
)
ŒŒ< =
{
 
if
ŽŽ 
(
ŽŽ 
computedHash
ŽŽ $
[
ŽŽ$ %
i
ŽŽ% &
]
ŽŽ& '
!=
ŽŽ( *

storedHash
ŽŽ+ 5
[
ŽŽ5 6
i
ŽŽ6 7
]
ŽŽ7 8
)
ŽŽ8 9
return
ŽŽ: @
false
ŽŽA F
;
ŽŽF G
}
 
}
 
return
’’ 
true
’’ 
;
’’ 
}
““ 	
}
”” 
}•• ð<
/D:\Git Repos\Going-Green\UserService\Startup.cs
	namespace 	
UserService
 
{ 
public 

class 
Startup 
{ 
private 
readonly 
IConfiguration '
_config( /
;/ 0
public 
Startup 
( 
IConfiguration %
config& ,
), -
{ 	
_config 
= 
config 
; 
} 	
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services 
. 
AddDbContext !
<! "
DataContext" -
>- .
(. /
options/ 6
=>7 9
{ 
options   
.   
	UseSqlite   !
(  ! "
_config  " )
.  ) *
GetConnectionString  * =
(  = >
$str  > Q
)  Q R
)  R S
;  S T
}!! 
)!! 
;!! 
services## 
.## 
AddTransient## !
<##! "
IUserService##" .
,##. /
UserService##0 ;
.##; <
Services##< D
.##D E
UserService##E P
>##P Q
(##Q R
)##R S
;##S T
services$$ 
.$$ 
AddAutoMapper$$ "
($$" #
	AppDomain$$# ,
.$$, -
CurrentDomain$$- :
.$$: ;
GetAssemblies$$; H
($$H I
)$$I J
)$$J K
;$$K L
services%% 
.%% 
AddCors%% 
(%% 
options%% $
=>%%% '
{&& 
options'' 
.'' 
AddDefaultPolicy'' (
(''( )
builder'') 0
=>''1 3
{(( 
builder)) 
.)) 
AllowAnyOrigin)) *
())* +
)))+ ,
;)), -
builder** 
.** 
AllowAnyMethod** *
(*** +
)**+ ,
;**, -
builder++ 
.++ 
AllowAnyHeader++ *
(++* +
)+++ ,
;++, -
},, 
),, 
;,, 
}-- 
)-- 
;-- 
services.. 
... 
AddControllers.. #
(..# $
)..$ %
;..% &
var11 
appSettingsSection11 "
=11# $
_config11% ,
.11, -

GetSection11- 7
(117 8
$str118 E
)11E F
;11F G
services22 
.22 
	Configure22 
<22 
AppSettings22 *
>22* +
(22+ ,
appSettingsSection22, >
)22> ?
;22? @
var55 
appSettings55 
=55 
appSettingsSection55 0
.550 1
Get551 4
<554 5
AppSettings555 @
>55@ A
(55A B
)55B C
;55C D
var66 
key66 
=66 
Encoding66 
.66 
UTF866 #
.66# $
GetBytes66$ ,
(66, -
appSettings66- 8
.668 9
Secret669 ?
)66? @
;66@ A
services77 
.77 
AddAuthentication77 &
(77& '
x77' (
=>77) +
{88 
x99 
.99 %
DefaultAuthenticateScheme99 +
=99, -
JwtBearerDefaults99. ?
.99? @ 
AuthenticationScheme99@ T
;99T U
x:: 
.:: "
DefaultChallengeScheme:: (
=::) *
JwtBearerDefaults::+ <
.::< = 
AuthenticationScheme::= Q
;::Q R
};; 
);; 
.<< 
AddJwtBearer<< 
(<< 
x<< 
=><< 
{== 
x>> 
.>> 
Events>> 
=>> 
new>> 
JwtBearerEvents>> .
{?? 
OnTokenValidated@@ $
=@@% &
context@@' .
=>@@/ 1
{AA 
varBB 
userServiceBB '
=BB( )
contextBB* 1
.BB1 2
HttpContextBB2 =
.BB= >
RequestServicesBB> M
.BBM N
GetRequiredServiceBBN `
<BB` a
IUserServiceBBa m
>BBm n
(BBn o
)BBo p
;BBp q
varCC 
userIdCC "
=CC# $
intCC% (
.CC( )
ParseCC) .
(CC. /
contextCC/ 6
.CC6 7
	PrincipalCC7 @
.CC@ A
IdentityCCA I
.CCI J
NameCCJ N
)CCN O
;CCO P
varDD 
userDD  
=DD! "
userServiceDD# .
.DD. /
GetByIdDD/ 6
(DD6 7
userIdDD7 =
)DD= >
;DD> ?
ifEE 
(EE 
userEE  
==EE! #
nullEE$ (
)EE( )
{FF 
contextHH #
.HH# $
FailHH$ (
(HH( )
$strHH) 7
)HH7 8
;HH8 9
}II 
returnJJ 
TaskJJ #
.JJ# $
CompletedTaskJJ$ 1
;JJ1 2
}KK 
,KK 
}LL 
;LL 
xMM 
.MM  
RequireHttpsMetadataMM &
=MM' (
falseMM) .
;MM. /
xNN 
.NN 
	SaveTokenNN 
=NN 
trueNN "
;NN" #
xOO 
.OO %
TokenValidationParametersOO +
=OO, -
newOO. 1%
TokenValidationParametersOO2 K
{PP $
ValidateIssuerSigningKeyQQ ,
=QQ- .
trueQQ/ 3
,QQ3 4
IssuerSigningKeyRR $
=RR% &
newRR' * 
SymmetricSecurityKeyRR+ ?
(RR? @
keyRR@ C
)RRC D
,RRD E
ValidateIssuerSS "
=SS# $
falseSS% *
,SS* +
ValidateAudienceTT $
=TT% &
falseTT' ,
}UU 
;UU 
}VV 
)VV 
;VV 
servicesYY 
.YY 
	AddScopedYY 
<YY 
IUserServiceYY +
,YY+ ,
UserServiceYY- 8
.YY8 9
ServicesYY9 A
.YYA B
UserServiceYYB M
>YYM N
(YYN O
)YYO P
;YYP Q
}[[ 	
public^^ 
void^^ 
	Configure^^ 
(^^ 
IApplicationBuilder^^ 1
app^^2 5
,^^5 6
IWebHostEnvironment^^7 J
env^^K N
)^^N O
{__ 	
if`` 
(`` 
env`` 
.`` 
IsDevelopment`` !
(``! "
)``" #
)``# $
{aa 
appbb 
.bb %
UseDeveloperExceptionPagebb -
(bb- .
)bb. /
;bb/ 0
}cc 
appee 
.ee 
UseHttpsRedirectionee #
(ee# $
)ee$ %
;ee% &
appgg 
.gg 

UseRoutinggg 
(gg 
)gg 
;gg 
appii 
.ii 
UseCorsii 
(ii 
)ii 
;ii 
appkk 
.kk 
UseAuthorizationkk  
(kk  !
)kk! "
;kk" #
appmm 
.mm 
UseEndpointsmm 
(mm 
	endpointsmm &
=>mm' )
{nn 
	endpointsoo 
.oo 
MapControllersoo (
(oo( )
)oo) *
;oo* +
}pp 
)pp 
;pp 
}qq 	
}rr 
}ss 